# Decisions — February 28, 2026

## Task: INFR-US6-A008 — Update developer documentation and ensure Makefiles support a complete development experience

**Requirements:** 1.8.5

### Decisions

**`widget-build` added to root Makefile**

A `make widget-build` target was added to the root Makefile, delegating to `$(MAKE) -C widget build`. This follows the existing pattern for database targets (`$(MAKE) -C api db-migrate`). The target allows a developer to build the production widget bundle (content-hashed) without starting the full dev stack.

**`services-up` comment updated to mention MinIO**

The `services-up` comment previously said "(PostgreSQL)". Since A003 added MinIO to Docker Compose, the comment was updated to "(PostgreSQL, MinIO)" to accurately reflect what the target starts. This is documentation accuracy, not a behavior change.

**README updated in place (not replaced)**

An existing `README.md` was found at the repo root. It was updated rather than replaced: MinIO was added to the dev stack description, `make widget-build` was added to the commands table, and three new sections were added (Development URLs, Widget Bundle, Configuration). The new sections cover the full CDN local-dev workflow introduced by INFR-US6 A003–A007.

**Widget bundle URL annotated for context**

The "Development URLs" table entry for the widget bundle includes "(when `make dev` is running)" because the URL is only valid when both the API server and widget watch process are active. This prevents developer confusion if the URL is tried before `make dev`.

**Configuration table mirrors config.yaml directly**

The Configuration section documents `cdn.serve_local`, `cdn.widget_dir`, `cdn.base_url`, and `storage.provider` with their exact default values from `config.yaml`. This avoids documentation drift — the table is easy to verify against the source of truth.

### Technical Challenges

**INFR-US6-A008 was missing from PROJECT_STATUS.md** — the task was listed in PROJECT_PLAN.md but not in the status tracking file. Added it with `✅ 2026-02-28` as part of this commit.

---

## Task: BLDR-US1-A001 — Set up React app with routing and auth state management

**Requirements:** 1.1.3, 1.2.2, 1.2.4

### Decisions

**Testing dependencies installed: @testing-library/react, @testing-library/jest-dom, @testing-library/user-event, jest-environment-jsdom, ts-jest, @types/jest**

All packages added as devDependencies in dashboard/package.json. `ts-jest` is available but not used directly — Next.js's `next/jest.js` integration handles TypeScript transformation automatically via babel. `@types/jest` is required for TypeScript to recognize `describe`, `it`, `expect`, and `jest.*` globals.

**jest.config.ts uses `next/jest.js` with ES module export**

Following the SKILL.md convention, `jest.config.ts` uses `import nextJest from 'next/jest.js'` and `export default createJestConfig(config)`. Jest setup uses `setupFilesAfterEnv` pointing to `jest.setup.ts` which imports `@testing-library/jest-dom`.

**`@types/jest` added to tsconfig.json `types` array**

Without `"types": ["jest"]` in tsconfig.json, TypeScript cannot find `describe`, `it`, `expect`, and `jest.*` in test files. This is a deliberate addition to the tsconfig that is workspace-safe.

**eslint.config.mjs updated to ignore `coverage/**`**

A leftover `coverage/` directory from an unsuccessful `--coverage` test run would cause ESLint to complain about a generated file. Added `coverage/**` to the globalIgnores list to prevent this.

**AuthState and AuthAction as discriminated unions in model/types.ts**

`AuthState` uses status discriminants: `'loading'`, `'unauthenticated'`, `'authenticated'`. The `'authenticated'` state carries a `token` property. `AuthAction` covers `auth_initialized` (with optional token), `login_succeeded` (with token), and `logout`.

**Pure reducer with no side effects in model/authReducer.ts**

The reducer is a pure function — no localStorage access, no side effects. localStorage sync is handled separately in `AuthContext.tsx` via a `useEffect` that watches `state`. This keeps the reducer testable in isolation.

**Two separate contexts for state and dispatch**

`AuthStateContext` and `AuthDispatchContext` are exported separately. This avoids re-rendering components that only consume dispatch when state changes. Follows the pattern from SKILL.md's `useConversations`/`useConversationsDispatch` example.

**localStorage access only in useEffect**

The `AuthProvider` never accesses `localStorage` during render. Two effects handle this:
1. Mount effect — reads localStorage and dispatches `auth_initialized`
2. State-watch effect — writes/clears localStorage when state becomes `authenticated` or `unauthenticated`

This prevents hydration mismatches in SSR (Next.js server never has access to localStorage).

**`useAuthState` and `useAuthDispatch` throw when used outside provider**

Both hooks check for null context and throw with descriptive error messages. This follows the pattern from SKILL.md.

**In-memory LocalStorageStub in tests (not jest.fn() mocks)**

Per SKILL.md convention, the test file contains a `LocalStorageStub` class that implements the `Storage` interface using a `Map<string, string>`. It is assigned to `window.localStorage` in `beforeEach`. This avoids per-test mocks and provides a realistic, reusable test double.

**The initial `loading` state is not directly observable in tests**

In the jsdom test environment, React Testing Library's `renderHook` wraps renders in `act()`, which flushes effects synchronously. The `loading` state transitions to `unauthenticated` or `authenticated` before `result.current` can be read. The `loading` state is validated by `authReducer.test.ts` (which tests the initial state shape) and by the type system. The provider tests focus on what is observably verifiable: post-hydration states and localStorage sync behavior.

**Next.js App Router route groups: `(auth)` and `(dashboard)`**

- `(auth)` group: `/login` and `/register` pages — no special layout
- `(dashboard)` group: layout with auth guard that redirects unauthenticated users to `/login`
- Root page (`/`) redirects based on auth state using `useRouter().replace()`

**Next.js 15+ async params in editor page**

The `[id]` dynamic segment uses `params: Promise<{ id: string }>` with `async/await` per the Next.js 15+ App Router pattern.

**`'use client'` directives placed only where needed**

- `entities/user/model/AuthContext.tsx` — uses hooks and browser APIs
- `app/providers.tsx` — renders a client component
- `app/page.tsx` — uses `useAuthState` and `useRouter` hooks
- `app/(dashboard)/layout.tsx` — uses `useAuthState` and `useRouter` hooks
- All other pages remain server components (no hooks)

### Technical Challenges

**`--coverage` flag breaks with the workspace-wide `minimatch` override**

The root `package.json` has a pnpm override forcing `minimatch@^10.2.3`. The `test-exclude@6.0.0` transitive dependency (used by Jest coverage instrumentation) requires `minimatch@^3.0.4` and calls `minimatch()` as a function directly. In minimatch v10, the function API changed (now requires `new Minimatch()` or uses different exports). This is a pre-existing workspace environment issue that breaks `jest --coverage`. Tests without `--coverage` run correctly. Removing the `collectCoverageFrom` option from jest.config.ts avoids triggering the broken path during normal test runs.

**Code review follow-up: `LocalStorageStub` extracted to `testing.ts`**

Per SKILL.md convention, reusable test implementations should live in a `testing.ts` file co-located with the slice, not inline in a test file. `LocalStorageStub` was moved from `AuthContext.test.tsx` to `entities/user/model/testing.ts` and re-exported. `AuthContext.test.tsx` now imports from `./testing`.

**Code review follow-up: additional `auth_initialized` reducer tests**

Added two tests covering `auth_initialized` dispatched from non-loading starting states (unauthenticated → authenticated with token; authenticated → unauthenticated without token). This closes the branch coverage gap noted in the review. Total test count: 18 tests across 2 suites.
