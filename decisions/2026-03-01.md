# Decision Log — 2026-03-01

## Task: BLDR-US2-A003 — Implement Dropdown field type with option list editor

**Requirement:** 1.3.1 — Builder supports Dropdown / Select fields with configurable options (label + value pairs)

---

## Decisions Made

### 1. `FieldOption` and `DropdownFieldConfig` placed in `shared/config/calculatorConfig.ts`

These types belong in `shared/config` because they are domain types shared across feature boundaries. `OptionListEditor` will be reused by A004 (Radio) and A005 (Checkbox), and those features also need `FieldOption`. Placing the types in `shared/config` prevents lateral imports between feature slices.

### 2. `generateId()` placed in `shared/lib/generateId.ts`

The ID generator is a stateless utility with no domain knowledge — it belongs in `shared/lib`. It is intentionally not exposed to tests so tests do not assert on ID format, only on the presence and type of the generated ID string.

### 3. `OptionListEditor` is deliberately unaware of field type

The component accepts `FieldOption[]` and `onChange: (options: FieldOption[]) => void` with no coupling to dropdown, radio, or checkbox. This allows A004 and A005 to reuse it directly without modification.

### 4. Index-based input IDs (`option-label-0`, `option-value-0`)

The task spec calls for index-based IDs since positions are stable within a single interaction. The `key` prop uses `option.id` (stable across re-renders) while the `htmlFor`/`id` pairing uses the array index so labels always associate with the correct input even after options are removed.

### 5. Disambiguation in `DropdownFieldConfigPanel` tests

When `DropdownFieldConfigPanel` renders both `FieldConfigPanel` (which has a "Label" label for `#field-label`) and `OptionListEditor` (which has "Label" labels for `#option-label-0`, `#option-label-1`, etc.), `getByLabelText('Label')` is ambiguous. Tests that target the base field label input use `getByLabelText('Label', { selector: '#field-label' })` to resolve the ambiguity without changing any production code.

### 6. `DropdownFieldConfigPanel.handleBaseUpdate` explicitly reattaches `type: 'dropdown'`

`FieldConfigPanel` receives and returns `BaseFieldConfig`, which only knows `type: FieldType`. When the base panel calls `onUpdate`, the returned object loses the `'dropdown'` discriminant. `handleBaseUpdate` spreads the base result and explicitly sets `type: 'dropdown'` alongside the existing `options` array to restore the `DropdownFieldConfig` shape.

---

## Technical Challenges

### Label ambiguity in `DropdownFieldConfigPanel` tests

When rendering both panels together, there are multiple elements labeled "Label" (one from the base panel's field label input, two from option label inputs). The fix was to qualify the base panel's label lookup with `{ selector: '#field-label' }` — the ID is fixed and stable in `FieldConfigPanel`.

No production code was changed to work around this; it was purely a test query precision issue.

---

## Bugfix: Next.js root path returning 404 (unrelated to any task)

### Problem

Running `make dev` in the `dashboard` package produced a 404 for `GET /` immediately on startup. All App Router routes were unreachable.

### Root cause

`next.config.ts` had a custom `pageExtensions: ['page.tsx', 'page.ts', 'page.jsx', 'page.js']` setting. The intent was to prevent Next.js from treating FSD barrel files in `src/pages/` (e.g. `src/pages/dashboard/index.ts`) as Pages Router routes.

The setting had the opposite effect on App Router files. Next.js constructs the expected filename for each App Router special file as `{special-name}.{extension}`. With the custom extensions, it looked for `page.page.tsx`, `layout.page.tsx`, etc. — none of which exist. Every route returned 404 as a result.

### Resolution

Two changes:

1. **Removed `pageExtensions` from `next.config.ts`**, restoring the default `['tsx', 'ts', 'jsx', 'js']`. This allows `page.tsx` and `layout.tsx` to be recognized as App Router special files again.

2. **Renamed `src/pages/` to `src/views/`**. With default extensions, Next.js would scan `src/pages/` and pick up FSD barrel files (e.g. `src/pages/dashboard/index.ts`) as Pages Router routes. Renaming the directory removes it from Next.js's scan path entirely without any framework configuration.

Import paths in the three App Router route files that referenced `@/pages/*` were updated to `@/views/*`.

---

## Task: BLDR-US2-A010 — Implement drag-and-drop field reordering

**Requirement:** 1.3.9 — Fields can be reordered via drag-and-drop

---

## Decisions Made

### useRef vs useState for draggingIndex
Used `useRef<number | null>` instead of `useState` for the active drag index. `handleDragOver` fires at high frequency; reading stale `useState` closures caused incorrect splice indices during rapid drags. `useRef.current` is read/written synchronously, eliminating the stale-closure bug. A separate `draggingId` state (`useState<string | null>`) drives the `data-dragging` attribute — it tracks the dragged item by its stable `field.id` so the visual indicator follows the item across reorders.

### if (e.dataTransfer) guard retained
`React.DragEvent<T>.dataTransfer` is typed as non-nullable, making the guard look like dead code. However, jsdom's `fireEvent.dragStart` does not populate `dataTransfer`, so the guard is required for test compatibility. A clarifying comment was added to explain this.

### Keyboard accessibility added
ArrowUp/ArrowDown reordering added via `onKeyDown` handler on each `<li>`, with `tabIndex={0}` for focusability. This goes beyond the literal drag-and-drop requirement but is needed to make the feature keyboard-accessible. The `handleKeyDown` swap uses destructuring assignment.

### onReorder fires on each dragOver, not on drop
Reorder is committed eagerly on every `dragOver` event rather than only on `drop`. This gives live feedback to the parent during drag and matches the live-preview requirement (1.3.11). The `handleDrop` handler only calls `e.preventDefault()` to suppress browser default drop behavior.

---

## Tasks: INFR-US2-A006 (db-seed) and INFR-US2-A007 (db-reset)

**Requirements:** Local development infrastructure — database seeding and reset tooling.

---

## Decisions Made

### 1. `hasher` injected as a function parameter in `run()`

`bcrypt.GenerateFromPassword` is passed as a `func([]byte, int) ([]byte, error)` argument to `run()`. This keeps the function pure for testing — tests substitute `fakeHasher` (deterministic, no bcrypt cost) and `errorHasher` (always fails) without needing any interface wrapping. The `main()` function passes `bcrypt.GenerateFromPassword` directly. This matches the task spec exactly and avoids over-engineering.

### 2. `UserSeeder` interface defined in the `main` package

The interface is defined where it is consumed (in `cmd/db-seed`) per the project's hexagonal architecture rule: interfaces belong at the consumer, not the implementer. There is no value in placing this interface in an internal package since `postgresSeeder` is only ever used by this command.

### 3. `postgresSeeder.SeedUser` wraps the email in the error message

The error from `db.ExecContext` is wrapped with the user's email so that if a seed fails in production, the log message identifies which user triggered the failure without requiring log correlation. The `ON CONFLICT (email) DO NOTHING` clause means conflicts are silently skipped — only genuine database errors propagate.

### 4. `stubSeeder` uses a 1-based `errOnCall` index

The test stub triggers an error on the Nth call (1-based). This makes it easy to express "fail on the second user" without additional state machinery. An `errOnCall` of 0 means never fail, matching the zero value of `int`.

### 5. A007 is pure Makefile composition — no new Go code

`db-reset` chains `migrate down -all`, `migrate up`, and `$(MAKE) db-seed`. Using `$(MAKE)` instead of a direct `go run` invocation ensures `DATABASE_URL` is forwarded correctly to the seed step and respects any future changes to the `db-seed` target without duplication.

### 6. `bcrypt.DefaultCost` (10) used in `run()` as the cost constant

The task spec says cost 10. `bcrypt.DefaultCost` is defined as 10 in the standard library, so it is used directly — makes the intent readable without a magic number.

---

## Technical Challenges

None. Both `github.com/lib/pq` and `golang.org/x/crypto` were already in `go.mod`, so no dependency changes were needed.


---

## Task: INFR-US2-A006 — db-seed make target

**Requirement:** 1.9.2, 1.9.8

---

## Decisions Made

### Architecture: cmd/db-seed + UserSeeder interface
Created a dedicated binary at `cmd/db-seed/` following the same `run()` extraction pattern as `cmd/api/`. The `UserSeeder` interface enables stub-based testing without a live database. The `hasher` function is injected as a function value rather than a type, which keeps the design simple for a single-use binary.

### Bcrypt cost 10 for dev seeds
Using `bcrypt.DefaultCost` (10) rather than production cost (12). Dev-only tool — speed is acceptable over the marginal security gain of higher cost.

### Idempotency via ON CONFLICT DO NOTHING
Re-running `make db-seed` never fails, always reaches the same end state. Existing users are silently skipped.

### Plaintext dev passwords in source
alice/bob/charlie dev credentials stored in source code. Acceptable for a local dev seed tool — these are never used in production and are not secrets.

