# Decisions — February 23, 2026

## Task: INFR-US5-A002 — Implement list calculators endpoint (scoped to authenticated user)

**Requirements:** 1.2.2

### Decisions

**`Lister` interface separate from `Creator`**

`ListCalculators` is defined on a new `Lister` interface, separate from `Creator`. `Create` only needs `Creator`; `List` only needs `Lister`. ISP: each consumer takes exactly the capability it needs. `PostgresCalculatorRepository` satisfies both. `NewService` now accepts both `creator Creator` and `lister Lister`. In `main.go`, `calcRepo` is passed for both since `PostgresCalculatorRepository` implements both interfaces.

**`CalculatorLister` defined in `server` package (consumer)**

Per the interfaces-at-consumer convention, `CalculatorLister` is defined in `internal/server/calculator.go`. `CalculatorService` is updated to embed both `CalculatorCreator` and `CalculatorLister`. The `calculator.Service` satisfies both without knowing about the server package.

**`make([]*Calculator, 0)` in `ListCalculators` for empty-list serialization**

Initializing the result slice with `make([]*Calculator, 0)` (rather than `var calcs []*Calculator`) ensures that when zero rows are returned, the variable is a non-nil empty slice. This serializes to `[]` in JSON rather than `null`. The `TestListCalculatorsHandler_Empty` test explicitly asserts `env.Data != nil` to enforce this invariant.

**Query uses `WHERE user_id = $1 AND is_deleted = FALSE ORDER BY updated_at DESC`**

The ownership filter (`user_id = $1`) is enforced at the database level, not the application level. The `user_id` value is derived exclusively from `UserIDFromContext(r.Context())` — the authenticated session — never from user-supplied request parameters. The soft-delete filter (`is_deleted = FALSE`) correctly excludes deleted calculators. Ordering by `updated_at DESC` gives the most recently modified calculator first, which is the natural UX ordering for a builder dashboard.

**`calculatorSummary` response type returns `id`, `created_at`, `updated_at`**

The list response omits `config`, `config_version`, `is_deleted`, and `user_id`. The dashboard needs a name/description per calculator (requirement 1.2.7), but those fields live inside the `config` JSONB and are not yet parsed by the API — that is deferred to the GET endpoint (INFR-US5-A003) and config update (INFR-US5-A004) tasks. The current summary is sufficient for the dashboard to render a list of calculators identified by UUID.

**`rows.Close()` deferred inside `ListCalculators`**

`defer rows.Close()` is called immediately after `QueryContext` succeeds. This is idiomatic Go and ensures rows are closed even if a scan error occurs mid-iteration. The `rows.Err()` check after the loop is still necessary — `rows.Close()` does not surface iteration errors.

### Technical Challenges

**`RowError(0, wantErr)` syntax for sqlmock v1**

sqlmock v1 supports injecting errors into specific rows via the `RowError(rowIndex int, err error)` method on `*Rows`. For `TestListCalculators_RowsError`, a valid row is added first (so `rows.Next()` iterates once), then `RowError(0, wantErr)` is called so that `rows.Err()` returns the configured error after the first row. This exercises the `rows.Err()` error path without triggering a scan failure.
